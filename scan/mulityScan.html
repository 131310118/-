<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>测试</title>
    <style>

        #banner {
            text-align: center;
            margin-bottom: 20px;
        }

        #main {
            width: 720px;
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }

        .tab {
            padding-left: 50px;
            padding-right: 50px;
            padding-bottom: 5px;
            padding-top: 5px;
            text-decoration: none;
            color: #000;
            font-size: large;
            margin-bottom: 20px;
        }

        #tab1 {
            background-color: #222;
            color: #FFF;
        }

        form {
            margin-top: 20px;
        }

        input {
            margin-right: 5px;
        }

        #result{
            max-width: 1000px;
            word-wrap: break-word;
        }

        #fs {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div id="main">
    <div id="banner"><b>HTML5 based JavaScript Network Reconnaissance Tool</b></div>
    <a class="tab" id="tab1" href="javascript:void(0)">Port Scanning</a>

    <form name="port_scan" onsubmit="return false">
        <label for="ip">IP Address: </label><input type="text" id="ip" size="15"/>
        <label for="num">number:</label><input type="text" id="num"/>
        <label for="start_port">Start Port: </label><input type="text" id="start_port" size="5"/>
        <label for="end_port">End Port: </label><input type="text" id="end_port" size="5"/>
        <input type="submit" value="Scan" style="margin-left:10px" onclick="scan_ports()"/>
        <br>
        Protocol :
        <input type="radio" name="protocol" value="0">Cross Origin Requests
        <input type="radio" name="protocol" value="1" checked>WebSockets
        <br>

        <div id="notes" style="text-align:left">
            <b>Note: </b>
            <br>
            * Tuned to scan fast internal networks. Scanning public/slow networks would require retuning.
            <br>
            * Works only on the versions of <b>FireFox, Chrome(recommended) and Safari</b> that support
            CrossOriginRequests/WebSockets
            <br>
            * Currently works on WINDOWS ONLY.
        </div>
    </form>
    <fieldset id="fs">
        <legend>Scan Output</legend>
        <div id="result"></div>
        <div id="log"></div>
    </fieldset>
    <img class="ajaxIMG" style="visibility:hidden" >
</div>
<script>
    var ajaxIMG = document.getElementsByClassName('ajaxIMG')[0];
    var imgTag = ajaxIMG.cloneNode(false);
    //var time = 0;
    //var scan_type = 1;
    //var start_time;
    var ip;//主域名
    //var domain;
    var num;//位数
    //var start_port;
    //var end_port;
    var current_port = -1;
    //var ps_open_ports = [];
    //var ps_maybe_open_ports = [];
    var closed_port_max = 2000;
    var open_port_max = 1000;
    var maybe_open_min = 10;
    var minInterval;//两次请求最小间隔时间
    var number = [0,1,2,3,4,5,6,7,8,9];
    var universalURL = 'aaaaaaaaaaaaaaaaaaaa';
    var isUniversal = true;//是否是泛域
    var letter = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'/*,'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'*/];
    //var blocked_ports = [0, 1, 7, 9, 11, 13, 15, 17, 19, 20, 21, 22, 23, 25, 37, 42, 43, 53, 77, 79, 87, 95, 101, 102, 103, 104, 109, 110, 111, 113, 115, 117, 119, 123, 135, 139, 143, 179, 389, 465, 512, 513, 514, 515, 526, 530, 531, 532, 540, 556, 563, 587, 601, 636, 993, 995, 2049, 4045, 6000];
    function is_valid_ip(ip) {
        var v_ip = ip.split(".");
        if (((v_ip[0] > 0) && (v_ip[0] <= 223)) && ((v_ip[1] >= 0) && (v_ip[1] <= 255)) && ((v_ip[2] >= 0) && (v_ip[2] <= 255)) && ((v_ip[3] > 0) && (v_ip[3] < 255))) {
            return true;
        }
        else {
            return /[a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?/.test(ip);
        }
    }
    function is_valid_port(v_port) {
        if (v_port > 0 && v_port < 65536) {
            return true;
        }
        else {
            return false;
        }
    }
    function is_blocked(port_no) {
        for (var i = 0; i < blocked_ports.length; i++) {
            if (blocked_ports[i] == port_no) {
                return true;
            }else if(blocked_ports[i] > port_no){
                return false;
            }
        }
        return false;
    }
    function reset_scan_out() {
        document.getElementById('result').innerHTML = "";
        document.getElementById('log').innerHTML = "";
    }
    function log(to_log) {
        document.getElementById('log').innerHTML += to_log + ", ";
    }
    function init_port_ps() {
        if(!isUniversal&&current_port==0){
            isUniversal = false;
            setInterval(results_ps,1000);
            for(var i=0;i<250;i++){
                setTimeout(dictonaryScan,1);
            }
            return 1;
        }else if(!isUniversal&&current_port>0){
            setTimeout(dictonaryScan,1);
            return 1;
        }
        else if(isUniversal&&(ps_open_ports.length)){
            document.getElementById('log').innerHTML = "该域名可能是泛域，无法扫描";
        }
        return 1;
    }
    function results_ps() {
        document.getElementById('result').innerHTML = "<br><b>Open Ports:</b><br>" + ps_open_ports + "<br>";/*<br><b>maybe open Ports:</b><br>" + ps_maybe_open_ports + "<br><br><b>Closed/Blocked Ports:</b><br>" + ps_closed_ports + "<br><br><b>Filtered/Application Type 3&4 Ports:</b><br>" + ps_timeout_ports + "<br><br>*/
    }
    function isuniversalURL(){
        if (document.port_scan.protocol[0].checked) {
            scan_ports_xhr(universalURL);
        }
    }
    ajaxIMG.parentNode.removeChild(ajaxIMG);
    function dictonaryScan(){
        if(current_port<num){
            var str = '',number = current_port,l = number%26;
            while(l>=0){
                var ss = letter[l];
                ss+=str;
                str = ss;
                number = str.length<2?Math.floor(number/26):Math.floor(number/27);
                l = (number%26==0&&number!=0?26:number%26)-1;
            }
            current_port++;
            scan_ports_xhr(str);
        }else{
            if(current_port==num){
                current_port++;
                alert('success');
            }
            return;
        }
    }
    function scan_ports() {
        isUniversal = true;
        ip = document.getElementById('ip').value;
        domain = ip.match(/(www.)?(.+)/)[2];
        num = document.getElementById('num').value;
        num = num>1?Math.pow(26,num-1)*27:26;
        if (!is_valid_ip(ip)) {
            alert("Invalid IP values entered");
            return;
        }
        current_port = 0;
        ps_open_ports = [];
        ps_maybe_open_ports = [];
        reset_scan_out();
        document.getElementById('log').innerHTML += "----------------<br><b>Scan Log:</b><br>";
        isuniversalURL();
    }
    function scan_open_xhr(){
        clearTimeout(this.time);
        ps_open_ports.push(this.secondDomain+'.'+domain);
        if(this.secondDomain==universalURL){
            isUniversal = true;
        }
        setTimeout(scan_ports_xhr,closed_port_max);
        delete this;
    }
    function check_ps_xhr() {
        clearTimeout(this.time);
        var interval = (new Date).getTime() - this.start_time;
        interval = interval>minInterval?minInterval:interval;
        if (interval < open_port_max && interval > maybe_open_min) {
            if(this.secondDomain==universalURL){
                maybe_open_min+=Math.floor(interval*Math.sqrt(interval));
                while(maybe_open_min<100){
                    maybe_open_min+=interval;
                }
                if(maybe_open_min>1000){
                    maybe_open_min = 1000;
                }
            }else{
                ps_maybe_open_ports.push(this.secondDomain+'.'+domain);
            }
        }
        isUniversal =false;
        setTimeout(scan_ports_xhr,closed_port_max);
        delete this;
    }
    function scan_ports_xhr(str) {
        if(!str){
            if (init_port_ps()) {
                return;
            }
        }
        var img = imgTag.cloneNode(false);
        img.secondDomain = str;
        img.onload=scan_open_xhr;
        img.onerror=function(){
            clearTimeout(this.time);
            img.onerror = function(){
                return;
            };
            img.onload = function(){
                return;
            };
            img.src = './default.jpg';
            if((new Date).getTime() - this.start_time<maybe_open_min){
                isUniversal = false;
                setTimeout(scan_ports_xhr,closed_port_max);
                delete this;
                return;
            }
            var newImg = imgTag.cloneNode(false);
            newImg.secondDomain = str;
            newImg.onload = scan_open_xhr;
            newImg.onerror = check_ps_xhr;
            try {
                newImg.src = "http://" + this.secondDomain+'.'+domain + "/favicon.ico"+("?v=" + Math.random()).replace(".","");
                newImg.start_time = (new Date).getTime();
                newImg.process = function(){
                    var interval = (new Date).getTime() - this.start_time;
                    if (interval >= closed_port_max) {
                        isUniversal =false;
                        clearTimeout(this.time);
                        newImg.onerror = function(){
                            return;
                        };
                        newImg.onload = function(){
                            return;
                        };
                        newImg.src = './default.jpg';
                        setTimeout(scan_ports_xhr,closed_port_max);
                        delete this;
                        return;
                    }else{
                        newImg.time = setTimeout(function(){newImg.process()},5);
                    }
                };
                newImg.time = setTimeout(function(){newImg.process()},5);
                delete img;
                return;
            }
            catch (err) {
                document.getElementById('result').innerHTML += "<b>Scan stopped. Exception: " + err + "</b>";
                return;
            }
        };
        try {
            img.src = "http://" + str+'.'+domain + "/favicon.ico"+("?v=" + Math.random()).replace(".","");
            img.start_time = (new Date).getTime();
            var interval = (new Date).getTime() - img.start_time;
            minInterval = interval;
            img.process = function(){
                interval = (new Date).getTime() - this.start_time;
                minInterval = interval;
                if (interval >= closed_port_max) {
                    clearTimeout(this.time);
                    img.onerror = function(){
                        return;
                    };
                    img.onload = function(){
                        return;
                    };
                    img.src = './default.jpg';
                    ajaxIMG = imgTag.cloneNode(false);
                    ajaxIMG.secondDomain = str;
                    ajaxIMG.onload=scan_open_xhr;
                    ajaxIMG.onerror=check_ps_xhr;
                    ajaxIMG.src = "http://" + str+'.'+domain + "/favicon.ico"+("?v=" + Math.random()).replace(".","");
                    ajaxIMG.start_time = (new Date).getTime();
                    ajaxIMG.process = function(){
                        var interval = (new Date).getTime() - this.start_time;
                        if (interval >= closed_port_max) {
                            isUniversal =false;
                            clearTimeout(this.time);
                            ajaxIMG.onerror = function(){
                                return;
                            };
                            ajaxIMG.onload = function(){
                                return;
                            };
                            ajaxIMG.src = './default.jpg';
                            setTimeout(scan_ports_xhr,closed_port_max);
                            delete this;
                            return;
                        }else{
                            ajaxIMG.time = setTimeout(function(){ajaxIMG.process()},5);
                        }
                    };
                    ajaxIMG.time = setTimeout(function(){ajaxIMG.process()},5);
                    delete img;
                }else{
                    img.time = setTimeout(function(){img.process()},5);
                }
            };
            img.time = setTimeout(function(){img.process()},5);
            return;
        }
        catch (err) {
            document.getElementById('result').innerHTML += "<b>Scan stopped. Exception: " + err + "</b>";
            return;
        }
    }
    function scan_ports_ws() {
        if (init_port_ps()) {
            return;
        }
        if (is_blocked(current_port)) {
            //log(ip+":"+current_port + " - blocked port");
            setTimeout("scan_ports_ws()", 1);
            return;
        }
        start_time = (new Date).getTime();
        try {
            ws = new WebSocket("ws://" + this.secondDomain+'.'+domain + ":" + current_port);
            setTimeout("check_ps_ws()", 5);
        }
        catch (err) {
            document.getElementById('result').innerHTML += "<b>Scan stopped. Exception: " + err + "</b>";
            return;
        }
    }
    function check_ps_ws() {
        var interval = (new Date).getTime() - start_time;
        if (ws.readyState == 0) {
            if (interval > closed_port_max) {
                //log(ip+":"+current_port + " - time exceeded");
                //ps_timeout_ports.push(ip+":"+current_port);
                setTimeout("scan_ports_ws()", 1);
            }
            else {
                setTimeout("check_ps_ws()", 5);
            }
        }
        else {
            if (interval < open_port_max) {
                //log(ip+":"+current_port + " - open");
                ps_open_ports.push(this.secoudDomain+'.'+domain);
            }
            else {
                //log(ip+":"+current_port + " - closed");
                //ps_closed_ports.push(ip+":"+current_port);
            }
            setTimeout("scan_ports_ws()", 1);
        }
    }
</script>
</body>
</html>